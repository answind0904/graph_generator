<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ê°„í¸ ê·¸ë˜í”„ ìƒì„±ê¸° & í¼ì„¼íŠ¸ ê³„ì‚°ê¸°</title>
    <!-- Tailwind CSS ë¡œë“œ -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Chart.js ë¼ì´ë¸ŒëŸ¬ë¦¬ ë¡œë“œ -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- Chart.js ë°ì´í„° ë¼ë²¨ í”ŒëŸ¬ê·¸ì¸ ë¡œë“œ -->
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.2.0/dist/chartjs-plugin-datalabels.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        /* Inter í°íŠ¸ ì ìš© */
        body {
            font-family: 'Inter', sans-serif;
        }
        /* ì¶”ê°€ ë°ì´í„°ì…‹ì˜ ë¼ë²¨ ìŠ¤íƒ€ì¼ */
        .synced-label {
            width: 40%; /* 2/5 width */
            padding-left: 0.5rem; /* px-2 */
            padding-right: 0.5rem; /* px-2 */
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            color: #4A5568; /* gray-700 */
        }
        /* íƒ­ í™œì„±í™” ìŠ¤íƒ€ì¼ */
        .tab-active {
            border-bottom: 2px solid #2563EB;
            color: #2563EB;
            font-weight: 700;
        }
        .tab-inactive {
            color: #6B7280;
            font-weight: 500;
        }
        .tab-inactive:hover {
            color: #374151;
        }
        /* ê³„ì‚°ê¸° ì…ë ¥ í•„ë“œ ìŠ¤íƒ€ì¼ */
        .calc-input {
            width: 100%; /* ê³ ì • ë„ˆë¹„ ì œê±°í•˜ê³  100%ë¡œ ë³€ê²½ */
            padding: 0.5rem;
            border: 1px solid #D1D5DB;
            border-radius: 0.375rem;
            text-align: right;
            font-weight: 600;
        }
        .calc-input:focus {
            outline: none;
            border-color: #3B82F6;
            box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.2);
        }
        /* ë“œë˜ê·¸ ì•¤ ë“œë¡­ ìŠ¤íƒ€ì¼ */
        .data-row.dragging {
            opacity: 0.5;
            background-color: #F3F4F6;
            border: 1px dashed #9CA3AF;
        }
        /* í•¸ë“¤ì—ë§Œ ì»¤ì„œ í¬ì¸í„° í‘œì‹œ */
        .drag-handle {
            cursor: grab;
        }
        .drag-handle:active {
            cursor: grabbing;
        }
    </style>
</head>
<body class="bg-gray-100 flex flex-col items-center min-h-screen p-4 sm:p-6 lg:p-8">

    <!-- íƒ­ ë„¤ë¹„ê²Œì´ì…˜ -->
    <div class="w-full max-w-6xl mx-auto mb-6 flex border-b border-gray-200">
        <button id="tab-graph-btn" class="flex-1 py-4 text-center tab-active transition-colors duration-200" onclick="switchTab('graph')">
            ğŸ“Š ê·¸ë˜í”„ ìƒì„±ê¸°
        </button>
        <button id="tab-calc-btn" class="flex-1 py-4 text-center tab-inactive transition-colors duration-200" onclick="switchTab('calc')">
            ğŸ§® í¼ì„¼íŠ¸ ê³„ì‚°ê¸°
        </button>
    </div>

    <!-- 1. ê·¸ë˜í”„ ìƒì„±ê¸° ì„¹ì…˜ -->
    <div id="graph-section" class="w-full max-w-6xl mx-auto grid grid-cols-1 lg:grid-cols-3 gap-8">
        
        <!-- ì™¼ìª½: ì…ë ¥ ì»¨íŠ¸ë¡¤ íŒ¨ë„ -->
        <div class="lg:col-span-1 bg-white p-6 rounded-2xl shadow-lg">
            <h1 class="text-2xl font-bold text-center text-gray-800 mb-6">ë°ì´í„° ì…ë ¥</h1>

            <!-- ê·¸ë˜í”„ ì¢…ë¥˜ ì„ íƒ -->
            <div class="mb-5">
                <label for="chartType" class="block text-sm font-medium text-gray-700 mb-2">ê·¸ë˜í”„ ì¢…ë¥˜</label>
                <select id="chartType" class="w-full px-3 py-2 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition">
                    <option value="bar">ë§‰ëŒ€ ê·¸ë˜í”„</option>
                    <option value="line">ì„  ê·¸ë˜í”„</option>
                    <option value="doughnut">ì› ê·¸ë˜í”„</option>
                    <option value="halfDoughnut">ë°˜ì› ì°¨íŠ¸</option>
                    <option value="polarArea">í´ë¼ ì°¨íŠ¸</option>
                    <option value="radar">ë ˆì´ë” ì°¨íŠ¸</option>
                    <option value="square">ì •ì‚¬ê°í˜• ì°¨íŠ¸</option>
                </select>
            </div>

            <hr class="my-6">

            <!-- ë™ì  ë°ì´í„° ì…ë ¥ í¼ (ë°ì´í„°ì…‹ 1) -->
            <label class="block text-sm font-medium text-gray-700 mb-2">ë°ì´í„° ì…ë ¥ (í•¸ë“¤ì„ ì¡ì•„ ìˆœì„œ ë³€ê²½)</label>
            <div id="data-input-container" class="space-y-2 mb-4">
                <!-- ìë°”ìŠ¤í¬ë¦½íŠ¸ë¡œ ë™ì  ìƒì„±ë  ì…ë ¥ í•„ë“œ ì˜ì—­ -->
            </div>
            
            <!-- í•©ê³„ í‘œì‹œ ì˜ì—­ -->
            <div class="text-right font-bold text-lg text-gray-800 mb-4" id="data-sum-display">
                í•©ê³„: 0
            </div>

            <!-- ì„  ê·¸ë˜í”„ ì „ìš©: ì¶”ê°€ ë°ì´í„°ì…‹ ì…ë ¥ ì˜ì—­ -->
            <div id="additional-datasets-container" class="hidden space-y-4 mb-4">
                <!-- ë°ì´í„°ì…‹ ì¶”ê°€ ë²„íŠ¼ìœ¼ë¡œ ë™ì  ìƒì„± -->
            </div>
            <button id="addDatasetBtn" class="hidden w-full bg-indigo-100 text-indigo-700 font-bold py-2 px-4 rounded-lg hover:bg-indigo-200 transition duration-300 mb-6">
                ë°ì´í„°ì…‹ ì¶”ê°€ (ì„  ê·¸ë˜í”„ìš©)
            </button>
            
            <div class="flex gap-2 mb-6">
                 <button id="addFieldBtn" class="w-1/2 bg-gray-200 text-gray-700 font-bold py-2 px-4 rounded-lg hover:bg-gray-300 transition duration-300">
                    í•­ëª© ì¶”ê°€
                </button>
                 <button id="saveChartBtn" class="w-1/2 bg-green-500 text-white font-bold py-2 px-4 rounded-lg hover:bg-green-600 transition duration-300">
                    ì´ë¯¸ì§€ ì €ì¥
                </button>
            </div>

            <!-- ê·¸ë˜í”„ ìƒì„± ë²„íŠ¼ (ìˆ˜ë™ ì—…ë°ì´íŠ¸ë¥¼ ìœ„í•´ ìœ ì§€) -->
            <button onclick="createOrUpdateChart()" class="w-full bg-blue-600 text-white font-bold py-3 px-4 rounded-lg hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 transition duration-300 shadow-md">
                ê·¸ë˜í”„ ìˆ˜ë™ ì—…ë°ì´íŠ¸
            </button>
        </div>

        <!-- ì˜¤ë¥¸ìª½: ê·¸ë˜í”„ê°€ ê·¸ë ¤ì§ˆ ì˜ì—­ -->
        <div class="lg:col-span-2 bg-white p-6 rounded-2xl shadow-lg flex items-center justify-center min-h-[400px]">
            <canvas id="myChart"></canvas>
        </div>
    </div>

    <!-- 2. í¼ì„¼íŠ¸ ê³„ì‚°ê¸° ì„¹ì…˜ (ì´ˆê¸° ìˆ¨ê¹€) -->
    <div id="calc-section" class="hidden w-full max-w-5xl mx-auto">
        <div class="bg-white p-6 rounded-2xl shadow-lg">
            <h2 class="text-2xl font-bold text-gray-800 mb-6 text-center">í¼ì„¼íŠ¸ ê³„ì‚°ê¸°</h2>
            
            <!-- ê³„ì‚°ê¸°ë“¤ì„ ì„¸ë¡œë¡œ ìŒ“ìŒ -->
            <div class="flex flex-col gap-4">
                
                <!-- ê³„ì‚°ê¸° 1: ë¹„ìœ¨ ê°’ ê³„ì‚° -->
                <div class="bg-gray-50 p-4 rounded-xl border border-gray-200 flex flex-col md:flex-row items-center gap-4">
                    <div class="font-bold text-gray-700 w-full md:w-32 flex items-center gap-2">
                        <span class="bg-blue-100 text-blue-600 rounded-full w-6 h-6 flex items-center justify-center text-sm">1</span>
                        ë¹„ìœ¨ ê°’
                    </div>
                    <div class="flex-1 flex flex-col sm:flex-row items-center gap-3 w-full">
                        <div class="flex items-center gap-2 w-full sm:flex-1">
                            <span class="text-gray-600 whitespace-nowrap">ì „ì²´</span>
                            <input type="number" id="calc1-total" class="calc-input" placeholder="10000">
                        </div>
                        <div class="flex items-center gap-2 w-full sm:flex-1">
                            <span class="text-gray-600 whitespace-nowrap">ì˜</span>
                            <input type="number" id="calc1-percent" class="calc-input" placeholder="20">
                            <span class="text-gray-600 whitespace-nowrap">% ëŠ”</span>
                        </div>
                    </div>
                    <div class="w-full md:w-48 bg-white p-3 rounded-lg border border-blue-200 flex items-center justify-between shadow-sm">
                        <span class="text-gray-400 text-sm">=</span>
                        <span id="calc1-result" class="text-xl font-bold text-blue-600">-</span>
                    </div>
                </div>

                <!-- ê³„ì‚°ê¸° 2: ì¼ë¶€ ê°’ ë¹„ìœ¨ -->
                <div class="bg-gray-50 p-4 rounded-xl border border-gray-200 flex flex-col md:flex-row items-center gap-4">
                    <div class="font-bold text-gray-700 w-full md:w-32 flex items-center gap-2">
                        <span class="bg-green-100 text-green-600 rounded-full w-6 h-6 flex items-center justify-center text-sm">2</span>
                        ì¼ë¶€ ë¹„ìœ¨
                    </div>
                    <div class="flex-1 flex flex-col sm:flex-row items-center gap-3 w-full">
                        <div class="flex items-center gap-2 w-full sm:flex-1">
                            <span class="text-gray-600 whitespace-nowrap">ì „ì²´</span>
                            <input type="number" id="calc2-total" class="calc-input" placeholder="5000">
                        </div>
                        <div class="flex items-center gap-2 w-full sm:flex-1">
                            <span class="text-gray-600 whitespace-nowrap">ì¤‘</span>
                            <input type="number" id="calc2-part" class="calc-input" placeholder="1000">
                            <span class="text-gray-600 whitespace-nowrap">ì€</span>
                        </div>
                    </div>
                    <div class="w-full md:w-48 bg-white p-3 rounded-lg border border-green-200 flex items-center justify-between shadow-sm">
                        <span class="text-gray-400 text-sm">=</span>
                        <span id="calc2-result" class="text-xl font-bold text-green-600">-</span>
                    </div>
                </div>

                <!-- ê³„ì‚°ê¸° 3: ì¦ê°ìœ¨ ê³„ì‚° -->
                <div class="bg-gray-50 p-4 rounded-xl border border-gray-200 flex flex-col md:flex-row items-center gap-4">
                    <div class="font-bold text-gray-700 w-full md:w-32 flex items-center gap-2">
                        <span class="bg-purple-100 text-purple-600 rounded-full w-6 h-6 flex items-center justify-center text-sm">3</span>
                        ì¦ê°ìœ¨
                    </div>
                    <div class="flex-1 flex flex-col sm:flex-row items-center gap-3 w-full">
                        <div class="flex items-center gap-2 w-full sm:flex-1">
                            <span class="text-gray-600 whitespace-nowrap">ê¸°ì¡´</span>
                            <input type="number" id="calc3-old" class="calc-input" placeholder="100">
                        </div>
                        <div class="flex items-center gap-2 w-full sm:flex-1">
                            <span class="text-gray-600 whitespace-nowrap">ì´</span>
                            <input type="number" id="calc3-new" class="calc-input" placeholder="150">
                            <span class="text-gray-600 whitespace-nowrap">ë˜ë©´</span>
                        </div>
                    </div>
                    <div class="w-full md:w-48 bg-white p-3 rounded-lg border border-purple-200 flex items-center justify-between shadow-sm">
                        <span class="text-gray-400 text-sm">=</span>
                        <span id="calc3-result" class="text-xl font-bold text-purple-600">-</span>
                    </div>
                </div>

                <!-- ê³„ì‚°ê¸° 4: ì¦ê°ëŸ‰ ê³„ì‚° -->
                <div class="bg-gray-50 p-4 rounded-xl border border-gray-200 flex flex-col md:flex-row items-center gap-4">
                    <div class="font-bold text-gray-700 w-full md:w-32 flex items-center gap-2">
                        <span class="bg-orange-100 text-orange-600 rounded-full w-6 h-6 flex items-center justify-center text-sm">4</span>
                        ì¦ê°ëŸ‰
                    </div>
                    <div class="flex-1 flex flex-col sm:flex-row items-center gap-3 w-full">
                        <div class="flex items-center gap-2 w-full sm:flex-1">
                            <span class="text-gray-600 whitespace-nowrap">ê°’</span>
                            <input type="number" id="calc4-val" class="calc-input" placeholder="10000">
                        </div>
                        <div class="flex items-center gap-2 w-full sm:flex-1">
                            <span class="text-gray-600 whitespace-nowrap">ì´</span>
                            <input type="number" id="calc4-percent" class="calc-input" placeholder="-20">
                            <span class="text-gray-600 whitespace-nowrap">% ì¦ê°</span>
                        </div>
                    </div>
                    <div class="w-full md:w-48 bg-white p-3 rounded-lg border border-orange-200 flex items-center justify-between shadow-sm">
                        <span class="text-gray-400 text-sm">=</span>
                        <span id="calc4-result" class="text-xl font-bold text-orange-600">-</span>
                    </div>
                </div>

            </div>
        </div>
    </div>

    <script>
        // --- íƒ­ ì „í™˜ ë¡œì§ ---
        function switchTab(tabName) {
            const graphSection = document.getElementById('graph-section');
            const calcSection = document.getElementById('calc-section');
            const tabGraphBtn = document.getElementById('tab-graph-btn');
            const tabCalcBtn = document.getElementById('tab-calc-btn');

            if (tabName === 'graph') {
                graphSection.classList.remove('hidden');
                graphSection.classList.add('grid');
                calcSection.classList.add('hidden');
                
                tabGraphBtn.classList.remove('tab-inactive');
                tabGraphBtn.classList.add('tab-active');
                tabCalcBtn.classList.remove('tab-active');
                tabCalcBtn.classList.add('tab-inactive');
            } else {
                graphSection.classList.add('hidden');
                graphSection.classList.remove('grid');
                calcSection.classList.remove('hidden');

                tabGraphBtn.classList.remove('tab-active');
                tabGraphBtn.classList.add('tab-inactive');
                tabCalcBtn.classList.remove('tab-inactive');
                tabCalcBtn.classList.add('tab-active');
            }
        }

        // --- í¼ì„¼íŠ¸ ê³„ì‚°ê¸° ë¡œì§ ---
        function formatNum(num) {
            return parseFloat(num.toFixed(2)).toLocaleString();
        }

        function calculate1() {
            const total = parseFloat(document.getElementById('calc1-total').value);
            const percent = parseFloat(document.getElementById('calc1-percent').value);
            const resultEl = document.getElementById('calc1-result');

            if (isNaN(total) || isNaN(percent)) {
                resultEl.innerText = "-";
                return;
            }
            const res = total * (percent / 100);
            resultEl.innerText = formatNum(res);
        }

        function calculate2() {
            const total = parseFloat(document.getElementById('calc2-total').value);
            const part = parseFloat(document.getElementById('calc2-part').value);
            const resultEl = document.getElementById('calc2-result');

            if (isNaN(total) || isNaN(part) || total === 0) {
                resultEl.innerText = "-";
                return;
            }
            const res = (part / total) * 100;
            resultEl.innerText = formatNum(res) + "%";
        }

        function calculate3() {
            const oldVal = parseFloat(document.getElementById('calc3-old').value);
            const newVal = parseFloat(document.getElementById('calc3-new').value);
            const resultEl = document.getElementById('calc3-result');

            if (isNaN(oldVal) || isNaN(newVal) || oldVal === 0) {
                resultEl.innerText = "-";
                return;
            }
            const diff = newVal - oldVal;
            const res = (diff / oldVal) * 100;
            const sign = res > 0 ? "ì¦ê°€" : (res < 0 ? "ê°ì†Œ" : "ë³€ë™ ì—†ìŒ");
            resultEl.innerText = `${formatNum(Math.abs(res))}% ${sign}`;
            resultEl.style.color = res > 0 ? "#EF4444" : (res < 0 ? "#3B82F6" : "#4B5563");
        }

        function calculate4() {
            const val = parseFloat(document.getElementById('calc4-val').value);
            const percent = parseFloat(document.getElementById('calc4-percent').value);
            const resultEl = document.getElementById('calc4-result');

            if (isNaN(val) || isNaN(percent)) {
                resultEl.innerText = "-";
                return;
            }
            
            const res = val * (1 + percent / 100);
            resultEl.innerText = formatNum(res);

            if (percent > 0) {
                resultEl.style.color = "#EF4444";
            } else if (percent < 0) {
                resultEl.style.color = "#3B82F6";
            } else {
                resultEl.style.color = "#F97316";
            }
        }

        // --- ê·¸ë˜í”„ ìƒì„±ê¸° ë¡œì§ ---
        Chart.register(ChartDataLabels);

        let myChart = null;
        let dragSrcRow = null; // ë“œë˜ê·¸ ì†ŒìŠ¤ ì €ì¥ìš© ë³€ìˆ˜

        function createOrUpdateChart() {
            const chartType = document.getElementById('chartType').value;
            const { labels, datasets, totalSum } = parseAllData(chartType);

            document.getElementById('data-sum-display').innerText = `í•©ê³„: ${totalSum.toLocaleString()}`;

            if (labels.length === 0 || datasets.length === 0 || datasets[0].data.length === 0) {
                if(myChart) myChart.destroy();
                myChart = null;
                return;
            }
            
            const ctx = document.getElementById('myChart').getContext('2d');
            if (myChart) myChart.destroy();

            const options = buildChartOptions(chartType, totalSum, datasets);
            
            let finalChartType = chartType;
            if (chartType === 'halfDoughnut') finalChartType = 'doughnut';
            if (chartType === 'square') finalChartType = 'scatter';

            myChart = new Chart(ctx, {
                type: finalChartType,
                data: { labels, datasets },
                options,
                plugins: [ChartDataLabels],
            });
        }
        
        function parseAllData(chartType) {
            const labelInputs = document.querySelectorAll('#data-input-container input[type="text"]');
            const dataInputs = document.querySelectorAll('#data-input-container input[type="number"]');

            const labels = Array.from(labelInputs).map(input => input.value.trim());
            const primaryData = Array.from(dataInputs).map(input => Number(input.value.trim()) || 0);
            
            let totalSum = primaryData.reduce((a, b) => a + b, 0);
            
            const baseColors = getBaseColors();
            let chartData = primaryData;
            const datasets = [{
                label: 'ë°ì´í„°ì…‹ 1',
                data: chartData,
                backgroundColor: getColors(labels.length, 0.7, baseColors, 0),
                borderColor: getColors(labels.length, 1, baseColors, 0),
                borderWidth: chartType === 'line' ? 3 : 1.5,
                tension: chartType === 'line' ? 0 : 0.2
            }];

            if (chartType === 'square') {
                const maxValue = Math.max(...primaryData, 0);
                const squareData = primaryData.map(value => {
                    const MAX_SIDE = 100; 
                    const MIN_SIDE = 15;
                    let side = MIN_SIDE;
                    if (maxValue > 0) {
                        side = (value / maxValue) * (MAX_SIDE - MIN_SIDE) + MIN_SIDE;
                    }
                    return { side: side, v: value };
                });

                const PADDING = 2;
                const totalWidth = squareData.reduce((sum, s) => sum + s.side + PADDING, 0);
                const wrapWidth = totalWidth / 2.2;

                let currentX = 0;
                let currentY = 0;
                let maxSideInRow = 0;

                chartData = squareData.map(square => {
                    if (currentX > 0 && currentX + square.side + PADDING > wrapWidth) {
                        currentY += maxSideInRow + PADDING;
                        currentX = 0;
                        maxSideInRow = 0;
                    }
                    
                    const xPos = currentX + (square.side / 2);
                    const yPos = currentY + (square.side / 2);

                    currentX += square.side + PADDING;
                    maxSideInRow = Math.max(maxSideInRow, square.side);

                    return { x: xPos, y: yPos, v: square.v, side: square.side };
                });
                
                const totalHeight = currentY + maxSideInRow;
                chartData.forEach(d => {
                    d.y = totalHeight - d.y;
                });

                datasets[0].data = chartData;
                datasets[0].pointStyle = 'rect';
                datasets[0].radius = chartData.map(d => d.side / 2);

            } else if (chartType === 'line') {
                document.querySelectorAll('.additional-dataset-block').forEach((block, index) => {
                    const name = block.querySelector('.dataset-name').value || `ë°ì´í„°ì…‹ ${index + 2}`;
                    const dataInputs = block.querySelectorAll('input[type="number"]');
                    const dataArr = Array.from(dataInputs).map(input => Number(input.value.trim()) || 0);
                    totalSum += dataArr.reduce((a, b) => a + b, 0);
                    
                    const colorSet = baseColors[(index + 1) % baseColors.length];
                    datasets.push({
                        label: name,
                        data: dataArr,
                        borderColor: colorSet['1'],
                        backgroundColor: colorSet['0.7'],
                        borderWidth: 3,
                        tension: 0
                    });
                });
            }
            return { labels, datasets, totalSum };
        }

        function buildChartOptions(chartType, sum, datasets) {
            const options = {
                responsive: true,
                maintainAspectRatio: true, 
                events: ['mousemove', 'mouseout', 'touchstart', 'touchmove'],
                plugins: {
                    legend: { position: 'top', onClick: null },
                    title: { display: true, text: 'ìƒì„±ëœ ê·¸ë˜í”„', font: { size: 18 } },
                    datalabels: {
                        formatter: (value, context) => {
                            const label = context.chart.data.labels[context.dataIndex];
                            if (['doughnut', 'polarArea', 'halfDoughnut'].includes(chartType)) {
                                const total = context.chart.data.datasets[0].data.reduce((a, b) => a + b, 0);
                                if (total === 0) return `${label}\n0 (0%)`;
                                const percentage = (value / total * 100).toFixed(1) + '%';
                                if (value / total < 0.05) return `${label}\n(${percentage})`;
                                return `${label}\n${value.toLocaleString()}\n(${percentage})`;
                            }
                            if (chartType === 'square') {
                                return `${label}\n${value.v.toLocaleString()}`;
                            }
                            return value.toLocaleString();
                        },
                        textShadowBlur: 10,
                        textShadowColor: 'rgba(0, 0, 0, 0.3)'
                    }
                },
                animation: false,
            };

            if (['doughnut', 'polarArea', 'halfDoughnut'].includes(chartType)) {
                Object.assign(options.plugins.datalabels, {
                    anchor: 'center', align: 'center', color: '#fff',
                    font: { weight: 'bold', size: 11 }
                });
            } else if (chartType === 'square') {
                Object.assign(options.plugins.datalabels, {
                    anchor: 'center', align: 'center', color: '#000',
                    font: { weight: 'bold', size: 12 },
                    textShadowBlur: 0
                });
            } else { 
                Object.assign(options.plugins.datalabels, {
                    anchor: 'end', align: 'end', color: '#333',
                    font: { weight: 'bold', size: 12 }
                });
            }
            
            if (chartType === 'halfDoughnut') {
                options.rotation = -90;
                options.circumference = 180;
                options.plugins.datalabels.display = (context) => context.dataset.data[context.dataIndex] > 0;
            }

            if (['bar', 'line'].includes(chartType)) {
                options.scales = { x: { display: true }, y: { display: true, beginAtZero: true, grace: '15%' } };
            } else if (chartType === 'square') {
                options.maintainAspectRatio = false;
                options.plugins.legend.display = false; 
                const squareData = datasets[0].data;
                const totalHeight = Math.max(...squareData.map(d => d.y + d.side / 2), 0);
                const totalWidth = Math.max(...squareData.map(d => d.x + d.side / 2), 0);
                
                options.scales = {
                    x: {
                        display: false,
                        min: 0,
                        max: totalWidth * 1.05
                    },
                    y: {
                        display: false,
                        min: 0,
                        max: totalHeight * 1.05,
                    }
                };
                 options.layout = { padding: 0 };
            } else if (['radar', 'polarArea'].includes(chartType)) {
                 options.scales = { r: { display: true } };
            }

            return options;
        }

        function getBaseColors() {
            return [
                { '0.7': 'rgba(59, 130, 246, 0.7)', '1': 'rgba(59, 130, 246, 1)' },
                { '0.7': 'rgba(239, 68, 68, 0.7)', '1': 'rgba(239, 68, 68, 1)' },
                { '0.7': 'rgba(16, 185, 129, 0.7)', '1': 'rgba(16, 185, 129, 1)' },
                { '0.7': 'rgba(245, 158, 11, 0.7)', '1': 'rgba(245, 158, 11, 1)' },
                { '0.7': 'rgba(139, 92, 246, 0.7)', '1': 'rgba(139, 92, 246, 1)' },
            ];
        }
        
        function getColors(count, opacityKey, baseColors, offset = 0) {
            let colors = [];
            for (let i = 0; i < count; i++) {
                colors.push(baseColors[(i + offset) % baseColors.length][opacityKey]);
            }
            return colors;
        }
        
        // --- ë“œë˜ê·¸ ì•¤ ë“œë¡­ ë¡œì§ ---
        function handleDragStart(e) {
            dragSrcRow = this;
            e.dataTransfer.effectAllowed = 'move';
            e.dataTransfer.setData('text/html', this.innerHTML);
            this.classList.add('dragging');
        }

        function handleDragOver(e) {
            if (e.preventDefault) e.preventDefault();
            e.dataTransfer.dropEffect = 'move';
            return false;
        }

        function handleDragEnd(e) {
            this.classList.remove('dragging');
            dragSrcRow = null;
            // ë“œë˜ê·¸ ì¢…ë£Œ ì‹œ ë°˜ë“œì‹œ draggable ì†ì„± ë¹„í™œì„±í™” (í…ìŠ¤íŠ¸ ì„ íƒ ê°„ì„­ ë°©ì§€)
            this.setAttribute('draggable', 'false');
        }

        function handleDrop(e) {
            if (e.stopPropagation) e.stopPropagation();

            if (dragSrcRow !== this) {
                const container = document.getElementById('data-input-container');
                const rows = Array.from(container.children);
                const fromIndex = rows.indexOf(dragSrcRow);
                const toIndex = rows.indexOf(this);

                // 1. ë©”ì¸ ë°ì´í„° í–‰ ì´ë™
                if (fromIndex < toIndex) {
                    this.after(dragSrcRow);
                } else {
                    this.before(dragSrcRow);
                }

                // 2. ì¶”ê°€ ë°ì´í„°ì…‹(ì„  ê·¸ë˜í”„ìš©)ì˜ í–‰ë“¤ë„ ë™ì¼í•˜ê²Œ ìˆœì„œ ì´ë™
                document.querySelectorAll('.additional-dataset-block .dataset-body').forEach(body => {
                    const subRows = Array.from(body.children);
                    if (subRows[fromIndex] && subRows[toIndex]) {
                        const subSrc = subRows[fromIndex];
                        const subTarget = subRows[toIndex];
                        if (fromIndex < toIndex) {
                            subTarget.after(subSrc);
                        } else {
                            subTarget.before(subSrc);
                        }
                    }
                });

                // 3. ì°¨íŠ¸ ë° ë°ì´í„° ë™ê¸°í™”
                syncLineDataInputs();
                createOrUpdateChart();
            }
            return false;
        }

        function addInputRow(label = '', value = '') {
            const container = document.getElementById('data-input-container');
            const row = document.createElement('div');
            // ë“œë˜ê·¸ ê°€ëŠ¥í•œ í–‰ ìŠ¤íƒ€ì¼ ë° ì†ì„± ì„¤ì •
            // ê¸°ë³¸ draggableì€ falseë¡œ ì„¤ì •í•˜ì—¬ í…ìŠ¤íŠ¸ ì„ íƒ ê°„ì„­ ë°©ì§€
            row.className = 'flex items-center gap-2 data-row group bg-white p-2 rounded-lg border border-transparent hover:border-gray-200 transition-all';
            row.draggable = false; 
            
            // ë“œë˜ê·¸ í•¸ë“¤ ì•„ì´ì½˜ (drag-handle í´ë˜ìŠ¤ ì¶”ê°€)
            const dragHandle = `<div class="drag-handle cursor-grab text-gray-400 hover:text-gray-600 p-1"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16"><path d="M7 2a1 1 0 1 1-2 0 1 1 0 0 1 2 0zm3 0a1 1 0 1 1-2 0 1 1 0 0 1 2 0zM7 5a1 1 0 1 1-2 0 1 1 0 0 1 2 0zm3 0a1 1 0 1 1-2 0 1 1 0 0 1 2 0zM7 8a1 1 0 1 1-2 0 1 1 0 0 1 2 0zm3 0a1 1 0 1 1-2 0 1 1 0 0 1 2 0zm-3 3a1 1 0 1 1-2 0 1 1 0 0 1 2 0zm3 0a1 1 0 1 1-2 0 1 1 0 0 1 2 0zm-3 3a1 1 0 1 1-2 0 1 1 0 0 1 2 0zm3 0a1 1 0 1 1-2 0 1 1 0 0 1 2 0z"/></svg></div>`;

            row.innerHTML = `
                ${dragHandle}
                <input type="text" value="${label}" class="flex-1 min-w-0 px-2 py-2 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500 text-sm" placeholder="í•­ëª©">
                <input type="number" value="${value}" class="w-24 px-2 py-2 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500 text-sm text-right" placeholder="ìˆ˜ì¹˜">
                <button onclick="removeInputRow(this)" class="text-red-400 hover:text-red-600 p-2 rounded-lg transition"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16"><path d="M4.646 4.646a.5.5 0 0 1 .708 0L8 7.293l2.646-2.647a.5.5 0 0 1 .708.708L8.707 8l2.647 2.646a.5.5 0 0 1-.708.708L8 8.707l-2.646 2.647a.5.5 0 0 1-.708-.708L7.293 8 4.646 5.354a.5.5 0 0 1 0-.708z"/></svg></button>
            `;

            // í•¸ë“¤ì— ë§ˆìš°ìŠ¤ê°€ ì˜¬ë¼ê°”ì„ ë•Œë§Œ ë“œë˜ê·¸ ê¸°ëŠ¥ í™œì„±í™”
            const handleDiv = row.querySelector('.drag-handle');
            handleDiv.addEventListener('mouseenter', () => {
                row.setAttribute('draggable', 'true');
            });
            handleDiv.addEventListener('mouseleave', () => {
                // ë“œë˜ê·¸ ì¤‘ì´ ì•„ë‹ ë•Œë§Œ ë¹„í™œì„±í™” (ë“œë˜ê·¸ ì‹œì‘ í›„ì—ëŠ” ë¸Œë¼ìš°ì €ê°€ ì²˜ë¦¬)
                if (!row.classList.contains('dragging')) {
                    row.setAttribute('draggable', 'false');
                }
            });

            // ë“œë˜ê·¸ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ë“±ë¡
            row.addEventListener('dragstart', handleDragStart);
            row.addEventListener('dragover', handleDragOver);
            row.addEventListener('drop', handleDrop);
            row.addEventListener('dragend', handleDragEnd);

            container.appendChild(row);
            syncLineDataInputs();
        }

        function removeInputRow(button) {
            button.closest('.data-row').remove();
            syncLineDataInputs();
            createOrUpdateChart();
        }

        function addDataset() {
            const container = document.getElementById('additional-datasets-container');
            const block = document.createElement('div');
            block.className = 'additional-dataset-block border p-3 rounded-lg';
            const datasetCount = container.children.length + 2;
            block.innerHTML = `
                <div class="flex justify-between items-center mb-2">
                    <input type="text" class="dataset-name w-full px-2 py-1 border-b" placeholder="ë°ì´í„°ì…‹ ${datasetCount} ì´ë¦„">
                    <button onclick="removeDataset(this)" class="bg-red-500 text-white text-xs font-bold py-1 px-2 rounded hover:bg-red-600 transition">X</button>
                </div>
                <div class="dataset-body space-y-2"></div>
            `;
            container.appendChild(block);
            syncLineDataInputs();
        }

        function removeDataset(button) {
            button.closest('.additional-dataset-block').remove();
            createOrUpdateChart();
        }

        function syncLineDataInputs() {
            const labels = Array.from(document.querySelectorAll('#data-input-container input[type="text"]')).map(input => input.value.trim());
            document.querySelectorAll('.additional-dataset-block').forEach(block => {
                const body = block.querySelector('.dataset-body');
                const existingValues = Array.from(body.querySelectorAll('input[type="number"]')).map(input => input.value);
                body.innerHTML = ''; 
                labels.forEach((label, index) => {
                    const value = existingValues[index] || '';
                    const row = document.createElement('div');
                    row.className = 'flex items-center gap-2';
                    row.innerHTML = `
                        <span class="synced-label" title="${label}">${label}</span>
                        <input type="number" value="${value}" class="w-2/5 px-2 py-2 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="ìˆ˜ì¹˜">
                        <div class="w-1/5"></div>
                    `;
                    body.appendChild(row);
                });
            });
        }
        
        function saveChartAsImage() {
            if (!myChart || !myChart.canvas) return;
            const sourceCanvas = myChart.canvas;
            const newCanvas = document.createElement('canvas');
            newCanvas.width = sourceCanvas.width; newCanvas.height = sourceCanvas.height;
            const newCtx = newCanvas.getContext('2d');
            newCtx.fillStyle = 'white';
            newCtx.fillRect(0, 0, newCanvas.width, newCanvas.height);
            newCtx.drawImage(sourceCanvas, 0, 0);
            const dataUrl = newCanvas.toDataURL('image/jpeg', 1.0);
            const link = document.createElement('a');
            link.href = dataUrl; link.download = 'graph-chart.jpeg';
            link.click();
        }

        function setupInitialFields() {
            addInputRow('ëŒ€í•œë¯¼êµ­', 5178); addInputRow('ì¼ë³¸', 12512);
            addInputRow('ë¯¸êµ­', 33189); addInputRow('ì¤‘êµ­', 141175);
            addInputRow('ì¸ë„', 142860);
        }
        
        window.onload = () => {
            setupInitialFields();
            createOrUpdateChart();

            document.getElementById('chartType').addEventListener('change', (e) => {
                const isLine = e.target.value === 'line';
                document.getElementById('addDatasetBtn').classList.toggle('hidden', !isLine);
                const container = document.getElementById('additional-datasets-container');
                container.classList.toggle('hidden', !isLine);
                if (!isLine) container.innerHTML = '';
                createOrUpdateChart();
            });

            document.getElementById('addFieldBtn').addEventListener('click', () => addInputRow());
            document.getElementById('addDatasetBtn').addEventListener('click', addDataset);
            document.getElementById('saveChartBtn').addEventListener('click', saveChartAsImage);
            document.getElementById('data-input-container').addEventListener('input', () => {
                syncLineDataInputs();
                createOrUpdateChart();
            });
            document.getElementById('additional-datasets-container').addEventListener('input', createOrUpdateChart);
            
            // --- í¼ì„¼íŠ¸ ê³„ì‚°ê¸°: ì‹¤ì‹œê°„ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ë“±ë¡ ---
            document.getElementById('calc1-total').addEventListener('input', calculate1);
            document.getElementById('calc1-percent').addEventListener('input', calculate1);
            document.getElementById('calc2-total').addEventListener('input', calculate2);
            document.getElementById('calc2-part').addEventListener('input', calculate2);
            document.getElementById('calc3-old').addEventListener('input', calculate3);
            document.getElementById('calc3-new').addEventListener('input', calculate3);
            document.getElementById('calc4-val').addEventListener('input', calculate4);
            document.getElementById('calc4-percent').addEventListener('input', calculate4);
        };
    </script>

</body>
</html>
