<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ê°„í¸ ê·¸ë˜í”„ ìƒì„±ê¸° & í¼ì„¼íŠ¸ ê³„ì‚°ê¸°</title>
    <!-- Tailwind CSS ë¡œë“œ -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Chart.js ë¼ì´ë¸ŒëŸ¬ë¦¬ ë¡œë“œ -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- Chart.js ë°ì´í„° ë¼ë²¨ í”ŒëŸ¬ê·¸ì¸ ë¡œë“œ -->
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.2.0/dist/chartjs-plugin-datalabels.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        /* Inter í°íŠ¸ ì ìš© */
        body {
            font-family: 'Inter', sans-serif;
        }
        /* ì¶”ê°€ ë°ì´í„°ì…‹ì˜ ë¼ë²¨ ìŠ¤íƒ€ì¼ */
        .synced-label {
            width: 40%; /* 2/5 width */
            padding-left: 0.5rem; /* px-2 */
            padding-right: 0.5rem; /* px-2 */
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            color: #4A5568; /* gray-700 */
        }
        /* íƒ­ í™œì„±í™” ìŠ¤íƒ€ì¼ */
        .tab-active {
            border-bottom: 2px solid #2563EB;
            color: #2563EB;
            font-weight: 700;
        }
        .tab-inactive {
            color: #6B7280;
            font-weight: 500;
        }
        .tab-inactive:hover {
            color: #374151;
        }
        /* ê³„ì‚°ê¸° ì…ë ¥ í•„ë“œ ìŠ¤íƒ€ì¼ */
        .calc-input {
            width: 100%;
            padding: 0.5rem;
            border: 1px solid #D1D5DB;
            border-radius: 0.375rem;
            text-align: right;
            font-weight: 600;
        }
        .calc-input:focus {
            outline: none;
            border-color: #3B82F6;
            box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.2);
        }
        /* ë“œë˜ê·¸ ì•¤ ë“œë¡­ ìŠ¤íƒ€ì¼ */
        .data-row.dragging {
            opacity: 0.5;
            background-color: #F3F4F6;
            border: 1px dashed #9CA3AF;
        }
        /* í•¸ë“¤ì—ë§Œ ì»¤ì„œ í¬ì¸í„° í‘œì‹œ */
        .drag-handle {
            cursor: grab;
        }
        .drag-handle:active {
            cursor: grabbing;
        }
        /* ì»¬ëŸ¬ ì¸ë””ì¼€ì´í„° ì»¤ì„œ */
        .color-indicator {
            cursor: pointer;
            border: 2px solid white;
            box-shadow: 0 0 0 1px #e5e7eb;
            transition: transform 0.1s;
        }
        .color-indicator:hover {
            transform: scale(1.1);
        }
        /* ì„ /ë ˆì´ë” ì°¨íŠ¸ì¼ ë•Œ í–‰ ì»¬ëŸ¬ ìˆ¨ê¹€ ì²˜ë¦¬ë¥¼ ìœ„í•œ í´ë˜ìŠ¤ */
        .hide-row-color .row-color-wrapper {
            display: none !important;
        }
    </style>
</head>
<body class="bg-gray-100 flex flex-col items-center min-h-screen p-4 sm:p-6 lg:p-8">

    <!-- íƒ­ ë„¤ë¹„ê²Œì´ì…˜ -->
    <div class="w-full max-w-6xl mx-auto mb-6 flex border-b border-gray-200">
        <button id="tab-graph-btn" class="flex-1 py-4 text-center tab-active transition-colors duration-200" onclick="switchTab('graph')">
            ğŸ“Š ê·¸ë˜í”„ ìƒì„±ê¸°
        </button>
        <button id="tab-calc-btn" class="flex-1 py-4 text-center tab-inactive transition-colors duration-200" onclick="switchTab('calc')">
            ğŸ§® í¼ì„¼íŠ¸ ê³„ì‚°ê¸°
        </button>
    </div>

    <!-- 1. ê·¸ë˜í”„ ìƒì„±ê¸° ì„¹ì…˜ -->
    <div id="graph-section" class="w-full max-w-6xl mx-auto grid grid-cols-1 lg:grid-cols-3 gap-8">
        
        <!-- ì™¼ìª½: ì…ë ¥ ì»¨íŠ¸ë¡¤ íŒ¨ë„ -->
        <div class="lg:col-span-1 bg-white p-6 rounded-2xl shadow-lg">
            <h1 class="text-2xl font-bold text-center text-gray-800 mb-6">ë°ì´í„° ì…ë ¥</h1>

            <!-- ê·¸ë˜í”„ ì¢…ë¥˜ ì„ íƒ -->
            <div class="mb-5">
                <label for="chartType" class="block text-sm font-medium text-gray-700 mb-2">ê·¸ë˜í”„ ì¢…ë¥˜</label>
                <select id="chartType" class="w-full px-3 py-2 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition">
                    <option value="bar">ë§‰ëŒ€ ê·¸ë˜í”„</option>
                    <option value="singleStackedBar">100% ë¹„ìœ¨ ë§‰ëŒ€ (ë¹„êµí˜•)</option>
                    <option value="line">ì„  ê·¸ë˜í”„</option>
                    <option value="doughnut">ì› ê·¸ë˜í”„</option>
                    <option value="halfDoughnut">ë°˜ì› ì°¨íŠ¸</option>
                    <option value="polarArea">í´ë¼ ì°¨íŠ¸</option>
                    <option value="radar">ë ˆì´ë” ì°¨íŠ¸</option>
                    <option value="square">ì •ì‚¬ê°í˜• ì°¨íŠ¸</option>
                </select>
            </div>

            <hr class="my-6">

            <!-- ë°ì´í„°ì…‹ ì´ë¦„ ë° ì „ì²´ ì»¬ëŸ¬ ì…ë ¥ (ì„ /ë ˆì´ë”ìš©) -->
            <div class="mb-4 flex gap-2 items-end">
                <div class="flex-1">
                    <label class="block text-sm font-medium text-gray-700 mb-1">ë°ì´í„°ì…‹ ì´ë¦„</label>
                    <input type="text" id="mainDatasetName" class="w-full px-3 py-2 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500 text-sm" value="ë°ì´í„°ì…‹ 1">
                </div>
                <!-- ë°ì´í„°ì…‹ ì „ì²´ ì»¬ëŸ¬ ì„ íƒê¸° (ì„ /ë ˆì´ë” ì°¨íŠ¸ì¼ ë•Œë§Œ í‘œì‹œë¨) -->
                <div id="mainDatasetColorContainer" class="hidden">
                    <label class="block text-sm font-medium text-gray-700 mb-1">ìƒ‰ìƒ</label>
                    <div class="relative h-[38px] w-[40px]">
                        <input type="color" id="mainDatasetColor" class="absolute inset-0 w-full h-full p-0 border-0 rounded cursor-pointer" value="#3B82F6">
                    </div>
                </div>
            </div>

            <!-- ë™ì  ë°ì´í„° ì…ë ¥ í¼ -->
            <label id="inputLabel" class="block text-sm font-medium text-gray-700 mb-2">ë°ì´í„° ì…ë ¥ (í•¸ë“¤ë¡œ ìˆœì„œ ë³€ê²½)</label>
            <div id="data-input-container" class="space-y-2 mb-4">
                <!-- ìë°”ìŠ¤í¬ë¦½íŠ¸ë¡œ ë™ì  ìƒì„±ë  ì…ë ¥ í•„ë“œ ì˜ì—­ -->
            </div>
            
            <!-- í•©ê³„ í‘œì‹œ ì˜ì—­ -->
            <div class="text-right font-bold text-lg text-gray-800 mb-4" id="data-sum-display">
                í•©ê³„: 0
            </div>

            <!-- ë‹¤ì¤‘ ë°ì´í„°ì…‹ ì…ë ¥ ì˜ì—­ -->
            <div id="additional-datasets-container" class="hidden space-y-4 mb-4">
                <!-- ë°ì´í„°ì…‹ ì¶”ê°€ ë²„íŠ¼ìœ¼ë¡œ ë™ì  ìƒì„± -->
            </div>
            <button id="addDatasetBtn" class="hidden w-full bg-indigo-100 text-indigo-700 font-bold py-2 px-4 rounded-lg hover:bg-indigo-200 transition duration-300 mb-6">
                ë°ì´í„°ì…‹ ì¶”ê°€ (ë¹„êµ ë°ì´í„°)
            </button>
            
            <div class="flex gap-2 mb-6">
                 <button id="addFieldBtn" class="w-1/2 bg-gray-200 text-gray-700 font-bold py-2 px-4 rounded-lg hover:bg-gray-300 transition duration-300">
                    í•­ëª© ì¶”ê°€
                </button>
                 <button id="saveChartBtn" class="w-1/2 bg-green-500 text-white font-bold py-2 px-4 rounded-lg hover:bg-green-600 transition duration-300">
                    ì´ë¯¸ì§€ ì €ì¥
                </button>
            </div>

            <!-- ê·¸ë˜í”„ ìƒì„± ë²„íŠ¼ -->
            <button onclick="createOrUpdateChart()" class="w-full bg-blue-600 text-white font-bold py-3 px-4 rounded-lg hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 transition duration-300 shadow-md">
                ê·¸ë˜í”„ ìˆ˜ë™ ì—…ë°ì´íŠ¸
            </button>
        </div>

        <!-- ì˜¤ë¥¸ìª½: ê·¸ë˜í”„ê°€ ê·¸ë ¤ì§ˆ ì˜ì—­ -->
        <div class="lg:col-span-2 bg-white p-6 rounded-2xl shadow-lg flex items-center justify-center min-h-[400px]">
            <canvas id="myChart"></canvas>
        </div>
    </div>

    <!-- 2. í¼ì„¼íŠ¸ ê³„ì‚°ê¸° ì„¹ì…˜ -->
    <div id="calc-section" class="hidden w-full max-w-5xl mx-auto">
        <div class="bg-white p-6 rounded-2xl shadow-lg">
            <h2 class="text-2xl font-bold text-gray-800 mb-6 text-center">í¼ì„¼íŠ¸ ê³„ì‚°ê¸°</h2>
            <div class="flex flex-col gap-4">
                <!-- ê³„ì‚°ê¸° 1 -->
                <div class="bg-gray-50 p-4 rounded-xl border border-gray-200 flex flex-col md:flex-row items-center gap-4">
                    <div class="font-bold text-gray-700 w-full md:w-32 flex items-center gap-2"><span class="bg-blue-100 text-blue-600 rounded-full w-6 h-6 flex items-center justify-center text-sm">1</span>ë¹„ìœ¨ ê°’</div>
                    <div class="flex-1 flex flex-col sm:flex-row items-center gap-3 w-full"><div class="flex items-center gap-2 w-full sm:flex-1"><span class="text-gray-600 whitespace-nowrap">ì „ì²´</span><input type="number" id="calc1-total" class="calc-input" placeholder="10000"></div><div class="flex items-center gap-2 w-full sm:flex-1"><span class="text-gray-600 whitespace-nowrap">ì˜</span><input type="number" id="calc1-percent" class="calc-input" placeholder="20"><span class="text-gray-600 whitespace-nowrap">% ëŠ”</span></div></div>
                    <div class="w-full md:w-48 bg-white p-3 rounded-lg border border-blue-200 flex items-center justify-between shadow-sm"><span class="text-gray-400 text-sm">=</span><span id="calc1-result" class="text-xl font-bold text-blue-600">-</span></div>
                </div>
                <!-- ê³„ì‚°ê¸° 2 -->
                <div class="bg-gray-50 p-4 rounded-xl border border-gray-200 flex flex-col md:flex-row items-center gap-4">
                    <div class="font-bold text-gray-700 w-full md:w-32 flex items-center gap-2"><span class="bg-green-100 text-green-600 rounded-full w-6 h-6 flex items-center justify-center text-sm">2</span>ì¼ë¶€ ë¹„ìœ¨</div>
                    <div class="flex-1 flex flex-col sm:flex-row items-center gap-3 w-full"><div class="flex items-center gap-2 w-full sm:flex-1"><span class="text-gray-600 whitespace-nowrap">ì „ì²´</span><input type="number" id="calc2-total" class="calc-input" placeholder="5000"></div><div class="flex items-center gap-2 w-full sm:flex-1"><span class="text-gray-600 whitespace-nowrap">ì¤‘</span><input type="number" id="calc2-part" class="calc-input" placeholder="1000"><span class="text-gray-600 whitespace-nowrap">ì€</span></div></div>
                    <div class="w-full md:w-48 bg-white p-3 rounded-lg border border-green-200 flex items-center justify-between shadow-sm"><span class="text-gray-400 text-sm">=</span><span id="calc2-result" class="text-xl font-bold text-green-600">-</span></div>
                </div>
                <!-- ê³„ì‚°ê¸° 3 -->
                <div class="bg-gray-50 p-4 rounded-xl border border-gray-200 flex flex-col md:flex-row items-center gap-4">
                    <div class="font-bold text-gray-700 w-full md:w-32 flex items-center gap-2"><span class="bg-purple-100 text-purple-600 rounded-full w-6 h-6 flex items-center justify-center text-sm">3</span>ì¦ê°ìœ¨</div>
                    <div class="flex-1 flex flex-col sm:flex-row items-center gap-3 w-full"><div class="flex items-center gap-2 w-full sm:flex-1"><span class="text-gray-600 whitespace-nowrap">ê¸°ì¡´</span><input type="number" id="calc3-old" class="calc-input" placeholder="100"></div><div class="flex items-center gap-2 w-full sm:flex-1"><span class="text-gray-600 whitespace-nowrap">ì´</span><input type="number" id="calc3-new" class="calc-input" placeholder="150"><span class="text-gray-600 whitespace-nowrap">ë˜ë©´</span></div></div>
                    <div class="w-full md:w-48 bg-white p-3 rounded-lg border border-purple-200 flex items-center justify-between shadow-sm"><span class="text-gray-400 text-sm">=</span><span id="calc3-result" class="text-xl font-bold text-purple-600">-</span></div>
                </div>
                <!-- ê³„ì‚°ê¸° 4 -->
                <div class="bg-gray-50 p-4 rounded-xl border border-gray-200 flex flex-col md:flex-row items-center gap-4">
                    <div class="font-bold text-gray-700 w-full md:w-32 flex items-center gap-2"><span class="bg-orange-100 text-orange-600 rounded-full w-6 h-6 flex items-center justify-center text-sm">4</span>ì¦ê°ëŸ‰</div>
                    <div class="flex-1 flex flex-col sm:flex-row items-center gap-3 w-full"><div class="flex items-center gap-2 w-full sm:flex-1"><span class="text-gray-600 whitespace-nowrap">ê°’</span><input type="number" id="calc4-val" class="calc-input" placeholder="10000"></div><div class="flex items-center gap-2 w-full sm:flex-1"><span class="text-gray-600 whitespace-nowrap">ì´</span><input type="number" id="calc4-percent" class="calc-input" placeholder="-20"><span class="text-gray-600 whitespace-nowrap">% ì¦ê°</span></div></div>
                    <div class="w-full md:w-48 bg-white p-3 rounded-lg border border-orange-200 flex items-center justify-between shadow-sm"><span class="text-gray-400 text-sm">=</span><span id="calc4-result" class="text-xl font-bold text-orange-600">-</span></div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // --- íƒ­ ì „í™˜ ë° í¼ì„¼íŠ¸ ê³„ì‚°ê¸° ë¡œì§ (ë³€ê²½ ì—†ìŒ) ---
        function switchTab(tabName) {
            const graphSection = document.getElementById('graph-section');
            const calcSection = document.getElementById('calc-section');
            const tabGraphBtn = document.getElementById('tab-graph-btn');
            const tabCalcBtn = document.getElementById('tab-calc-btn');
            if (tabName === 'graph') {
                graphSection.classList.remove('hidden'); graphSection.classList.add('grid');
                calcSection.classList.add('hidden');
                tabGraphBtn.classList.remove('tab-inactive'); tabGraphBtn.classList.add('tab-active');
                tabCalcBtn.classList.remove('tab-active'); tabCalcBtn.classList.add('tab-inactive');
            } else {
                graphSection.classList.add('hidden'); graphSection.classList.remove('grid');
                calcSection.classList.remove('hidden');
                tabGraphBtn.classList.remove('tab-active'); tabGraphBtn.classList.add('tab-inactive');
                tabCalcBtn.classList.remove('tab-inactive'); tabCalcBtn.classList.add('tab-active');
            }
        }
        function formatNum(num) { return parseFloat(num.toFixed(2)).toLocaleString(); }
        function calculate1() {
            const total = parseFloat(document.getElementById('calc1-total').value);
            const percent = parseFloat(document.getElementById('calc1-percent').value);
            const resultEl = document.getElementById('calc1-result');
            if (isNaN(total) || isNaN(percent)) { resultEl.innerText = "-"; return; }
            resultEl.innerText = formatNum(total * (percent / 100));
        }
        function calculate2() {
            const total = parseFloat(document.getElementById('calc2-total').value);
            const part = parseFloat(document.getElementById('calc2-part').value);
            const resultEl = document.getElementById('calc2-result');
            if (isNaN(total) || isNaN(part) || total === 0) { resultEl.innerText = "-"; return; }
            resultEl.innerText = formatNum((part / total) * 100) + "%";
        }
        function calculate3() {
            const oldVal = parseFloat(document.getElementById('calc3-old').value);
            const newVal = parseFloat(document.getElementById('calc3-new').value);
            const resultEl = document.getElementById('calc3-result');
            if (isNaN(oldVal) || isNaN(newVal) || oldVal === 0) { resultEl.innerText = "-"; return; }
            const res = ((newVal - oldVal) / oldVal) * 100;
            const sign = res > 0 ? "ì¦ê°€" : (res < 0 ? "ê°ì†Œ" : "ë³€ë™ ì—†ìŒ");
            resultEl.innerText = `${formatNum(Math.abs(res))}% ${sign}`;
            resultEl.style.color = res > 0 ? "#EF4444" : (res < 0 ? "#3B82F6" : "#4B5563");
        }
        function calculate4() {
            const val = parseFloat(document.getElementById('calc4-val').value);
            const percent = parseFloat(document.getElementById('calc4-percent').value);
            const resultEl = document.getElementById('calc4-result');
            if (isNaN(val) || isNaN(percent)) { resultEl.innerText = "-"; return; }
            const res = val * (1 + percent / 100);
            resultEl.innerText = formatNum(res);
            if (percent > 0) resultEl.style.color = "#EF4444";
            else if (percent < 0) resultEl.style.color = "#3B82F6";
            else resultEl.style.color = "#F97316";
        }

        // --- ê·¸ë˜í”„ ìƒì„±ê¸° ë¡œì§ ---
        Chart.register(ChartDataLabels);

        let myChart = null;
        let dragSrcRow = null; 

        function getBaseColors() {
            return [
                { '0.7': 'rgba(59, 130, 246, 0.7)', '1': '#3B82F6' }, // íŒŒë‘
                { '0.7': 'rgba(107, 114, 128, 0.7)', '1': '#6B7280' }, // íšŒìƒ‰
                { '0.7': 'rgba(239, 68, 68, 0.7)', '1': '#EF4444' }, // ë¹¨ê°•
                { '0.7': 'rgba(16, 185, 129, 0.7)', '1': '#10B981' }, // ì´ˆë¡
                { '0.7': 'rgba(245, 158, 11, 0.7)', '1': '#F59E0B' }, // ì£¼í™©
                { '0.7': 'rgba(139, 92, 246, 0.7)', '1': '#8B5CF6' }, // ë³´ë¼
            ];
        }

        function hexToRgba(hex, alpha) {
            let r = 0, g = 0, b = 0;
            if (hex.length === 4) {
                r = parseInt(hex[1] + hex[1], 16);
                g = parseInt(hex[2] + hex[2], 16);
                b = parseInt(hex[3] + hex[3], 16);
            } else if (hex.length === 7) {
                r = parseInt(hex.substring(1, 3), 16);
                g = parseInt(hex.substring(3, 5), 16);
                b = parseInt(hex.substring(5, 7), 16);
            }
            return `rgba(${r}, ${g}, ${b}, ${alpha})`;
        }

        function updateAllTotals() {
            const dataInputs = document.querySelectorAll('#data-input-container input[type="number"]');
            const mainTotal = Array.from(dataInputs)
                .map(input => Number(input.value.trim()) || 0)
                .reduce((a, b) => a + b, 0);
            document.getElementById('data-sum-display').innerText = `í•©ê³„: ${mainTotal.toLocaleString()}`;

            const additionalBlocks = document.querySelectorAll('.additional-dataset-block');
            additionalBlocks.forEach(block => {
                const inputs = block.querySelectorAll('input[type="number"]');
                const subTotal = Array.from(inputs)
                    .map(input => Number(input.value.trim()) || 0)
                    .reduce((a, b) => a + b, 0);
                
                const sumDisplay = block.querySelector('.dataset-total-display');
                if (sumDisplay) {
                    sumDisplay.innerText = `í•©ê³„: ${subTotal.toLocaleString()}`;
                }
            });
        }

        function createOrUpdateChart() {
            const chartType = document.getElementById('chartType').value;
            const { labels, datasets, totalSum } = parseAllData(chartType);

            updateAllTotals();

            if (labels.length === 0 || datasets.length === 0 || (datasets[0].data.length === 0 && chartType !== 'singleStackedBar')) {
                if(myChart) myChart.destroy();
                myChart = null;
                return;
            }
            
            const ctx = document.getElementById('myChart').getContext('2d');
            if (myChart) myChart.destroy();

            const options = buildChartOptions(chartType, totalSum, datasets);
            
            let finalChartType = chartType;
            if (chartType === 'halfDoughnut') finalChartType = 'doughnut';
            if (chartType === 'square') finalChartType = 'scatter';
            if (chartType === 'singleStackedBar') finalChartType = 'bar'; 

            myChart = new Chart(ctx, {
                type: finalChartType,
                data: { labels, datasets },
                options,
                plugins: [ChartDataLabels],
            });
        }
        
        function parseAllData(chartType) {
            const labelInputs = document.querySelectorAll('#data-input-container input[type="text"]');
            const dataInputs = document.querySelectorAll('#data-input-container input[type="number"]');
            const colorInputs = document.querySelectorAll('#data-input-container input[type="color"]');
            
            const mainDatasetName = document.getElementById('mainDatasetName').value || 'ë°ì´í„°ì…‹ 1';
            const mainDatasetColor = document.getElementById('mainDatasetColor').value;

            const labelValues = Array.from(labelInputs).map(input => input.value.trim());
            const dataValues = Array.from(dataInputs).map(input => Number(input.value.trim()) || 0);
            const rowColors = Array.from(colorInputs).map(input => input.value);
            
            let totalSum = dataValues.reduce((a, b) => a + b, 0);
            
            const baseColors = getBaseColors();
            let datasets = [];
            let chartLabels = [];

            if (chartType === 'line' || chartType === 'radar') {
                chartLabels = labelValues;
                datasets.push({
                    label: mainDatasetName,
                    data: dataValues,
                    borderColor: mainDatasetColor,
                    backgroundColor: hexToRgba(mainDatasetColor, chartType === 'radar' ? 0.2 : 0.1),
                    pointBackgroundColor: mainDatasetColor,
                    pointBorderColor: '#fff',
                    pointHoverBackgroundColor: '#fff',
                    pointHoverBorderColor: mainDatasetColor,
                    borderWidth: 3,
                    tension: chartType === 'line' ? 0 : 0.1,
                    fill: chartType === 'radar' 
                });

                document.querySelectorAll('.additional-dataset-block').forEach((block, index) => {
                    const name = block.querySelector('.dataset-name').value || `ë°ì´í„°ì…‹ ${index + 2}`;
                    const dsColor = block.querySelector('.dataset-color-picker')?.value || baseColors[(index+1)%baseColors.length]['1'];
                    const inputs = block.querySelectorAll('input.dataset-value'); 
                    const arr = Array.from(inputs).map(input => Number(input.value.trim()) || 0);
                    
                    datasets.push({
                        label: name,
                        data: arr,
                        borderColor: dsColor,
                        backgroundColor: hexToRgba(dsColor, chartType === 'radar' ? 0.2 : 0.1),
                        pointBackgroundColor: dsColor,
                        pointBorderColor: '#fff',
                        pointHoverBackgroundColor: '#fff',
                        pointHoverBorderColor: dsColor,
                        borderWidth: 3,
                        tension: chartType === 'line' ? 0 : 0.1,
                        fill: chartType === 'radar'
                    });
                });

            } else if (chartType === 'singleStackedBar') {
                chartLabels = [mainDatasetName];
                const additionalBlocks = document.querySelectorAll('.additional-dataset-block');
                additionalBlocks.forEach((block, i) => {
                    const name = block.querySelector('.dataset-name').value || `ë°ì´í„°ì…‹ ${i + 2}`;
                    chartLabels.push(name);
                });

                const segments = labelValues.map((name, i) => {
                    const hexColor = rowColors[i] || baseColors[i % baseColors.length]['1'];
                    return {
                        label: name || `í•­ëª© ${i + 1}`,
                        values: [dataValues[i]], 
                        backgroundColor: hexToRgba(hexColor, 0.7),
                        borderColor: hexToRgba(hexColor, 1.0)
                    };
                });

                additionalBlocks.forEach((block) => {
                    const inputs = block.querySelectorAll('input.dataset-value');
                    inputs.forEach((input, i) => {
                        if (segments[i]) {
                            segments[i].values.push(Number(input.value) || 0);
                        }
                    });
                });

                const barTotals = new Array(chartLabels.length).fill(0);
                segments.forEach(seg => {
                    seg.values.forEach((val, colIndex) => {
                        barTotals[colIndex] += val;
                    });
                });

                datasets = segments.map(seg => {
                    const percentData = seg.values.map((val, colIndex) => {
                        const total = barTotals[colIndex];
                        return total === 0 ? 0 : (val / total) * 100;
                    });

                    return {
                        label: seg.label,
                        data: percentData,
                        originalData: seg.values, 
                        backgroundColor: seg.backgroundColor,
                        borderColor: seg.borderColor,
                        borderWidth: 1,
                        barPercentage: 0.6,
                    };
                });

            } else {
                chartLabels = labelValues;
                const backgroundColors = rowColors.map(hex => hexToRgba(hex, 0.7));
                const borderColors = rowColors.map(hex => hexToRgba(hex, 1.0));

                datasets.push({
                    label: mainDatasetName,
                    data: dataValues,
                    backgroundColor: backgroundColors,
                    borderColor: borderColors,
                    borderWidth: 1.5,
                    tension: 0.2
                });

                if (chartType === 'square') {
                    const maxValue = Math.max(...dataValues, 0);
                    const squareData = dataValues.map(value => {
                        const MAX_SIDE = 100; 
                        const MIN_SIDE = 15;
                        let side = MIN_SIDE;
                        if (maxValue > 0) side = (value / maxValue) * (MAX_SIDE - MIN_SIDE) + MIN_SIDE;
                        return { side: side, v: value };
                    });
                    const PADDING = 2;
                    const totalWidth = squareData.reduce((sum, s) => sum + s.side + PADDING, 0);
                    const wrapWidth = totalWidth / 2.2;
                    let currentX = 0, currentY = 0, maxSideInRow = 0;
                    
                    const mappedData = squareData.map(square => {
                        if (currentX > 0 && currentX + square.side + PADDING > wrapWidth) {
                            currentY += maxSideInRow + PADDING;
                            currentX = 0; maxSideInRow = 0;
                        }
                        const xPos = currentX + (square.side / 2);
                        const yPos = currentY + (square.side / 2);
                        currentX += square.side + PADDING;
                        maxSideInRow = Math.max(maxSideInRow, square.side);
                        return { x: xPos, y: yPos, v: square.v, side: square.side };
                    });
                    const totalHeight = currentY + maxSideInRow;
                    mappedData.forEach(d => { d.y = totalHeight - d.y; });

                    datasets[0].data = mappedData;
                    datasets[0].pointStyle = 'rect';
                    datasets[0].radius = mappedData.map(d => d.side / 2);
                    datasets[0].backgroundColor = backgroundColors;
                } 
            }

            return { labels: chartLabels, datasets, totalSum };
        }

        function updateUIForChartType(chartType) {
            const isLineOrRadar = chartType === 'line' || chartType === 'radar';
            
            const mainColorContainer = document.getElementById('mainDatasetColorContainer');
            if (isLineOrRadar) mainColorContainer.classList.remove('hidden');
            else mainColorContainer.classList.add('hidden');

            const inputContainer = document.getElementById('data-input-container');
            if (isLineOrRadar) inputContainer.classList.add('hide-row-color');
            else inputContainer.classList.remove('hide-row-color');

            document.querySelectorAll('.additional-dataset-block').forEach(block => {
                const picker = block.querySelector('.dataset-color-container');
                if (picker) {
                    if (isLineOrRadar) picker.classList.remove('hidden');
                    else picker.classList.add('hidden');
                }
            });
        }

        function buildChartOptions(chartType, sum, datasets) {
            const options = {
                responsive: true,
                maintainAspectRatio: true,
                plugins: {
                    legend: { position: 'top', onClick: null },
                    title: { display: true, text: 'ìƒì„±ëœ ê·¸ë˜í”„', font: { size: 18 } },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                let label = context.dataset.label || '';
                                if (label) label += ': ';
                                if (chartType === 'singleStackedBar') {
                                    const percent = context.raw.toFixed(1);
                                    const originalVal = context.dataset.originalData[context.dataIndex];
                                    return `${label}${originalVal.toLocaleString()} (${percent}%)`;
                                }
                                if (context.parsed.y !== null && chartType !== 'square') {
                                     return label + context.parsed.y.toLocaleString();
                                }
                                return label + (context.raw.v ? context.raw.v.toLocaleString() : context.raw.toLocaleString());
                            }
                        }
                    },
                    datalabels: {
                        formatter: (value, context) => {
                            const label = context.chart.data.labels[context.dataIndex];
                            if (chartType === 'singleStackedBar') {
                                if (value === 0) return '';
                                const percent = value.toFixed(1);
                                const originalVal = context.dataset.originalData[context.dataIndex];
                                if (value < 5) return ''; 
                                return `${originalVal}\n(${percent}%)`;
                            }
                            if (['doughnut', 'polarArea', 'halfDoughnut'].includes(chartType)) {
                                const total = context.chart.data.datasets[0].data.reduce((a, b) => a + b, 0);
                                if (total === 0) return `${label}\n0 (0%)`;
                                const percentage = (value / total * 100).toFixed(1) + '%';
                                if (value / total < 0.05) return `${label}\n(${percentage})`;
                                return `${label}\n${value.toLocaleString()}\n(${percentage})`;
                            }
                            if (chartType === 'square') {
                                return `${context.chart.data.labels[context.dataIndex]}\n${value.v.toLocaleString()}`;
                            }
                            if (typeof value === 'number') return value.toLocaleString();
                            return value;
                        },
                        textShadowBlur: 10,
                        textShadowColor: 'rgba(0, 0, 0, 0.3)'
                    }
                },
                animation: false,
            };

            if (chartType === 'singleStackedBar') options.indexAxis = 'y';

            if (['doughnut', 'polarArea', 'halfDoughnut', 'singleStackedBar', 'radar'].includes(chartType)) {
                Object.assign(options.plugins.datalabels, {
                    anchor: 'center', align: 'center', color: '#fff',
                    font: { weight: 'bold', size: 11 },
                    textShadowBlur: 4, textShadowColor: 'rgba(0,0,0,0.5)'
                });
            } else if (chartType === 'square') {
                Object.assign(options.plugins.datalabels, {
                    anchor: 'center', align: 'center', color: '#000',
                    font: { weight: 'bold', size: 12 }, textShadowBlur: 0
                });
            } else { 
                Object.assign(options.plugins.datalabels, {
                    anchor: 'end', align: 'end', color: '#333',
                    font: { weight: 'bold', size: 12 }
                });
            }
            
            if (chartType === 'halfDoughnut') {
                options.rotation = -90; options.circumference = 180;
                options.plugins.datalabels.display = (context) => context.dataset.data[context.dataIndex] > 0;
            }

            if (['bar', 'line', 'singleStackedBar'].includes(chartType)) {
                 const isStacked = chartType === 'singleStackedBar';
                 options.scales = { 
                    x: { display: true, stacked: isStacked, beginAtZero: true, max: isStacked ? 100 : undefined, grid: { display: !isStacked } }, 
                    y: { display: true, stacked: isStacked, beginAtZero: true, grace: isStacked ? undefined : '15%', grid: { display: !isStacked } } 
                };
            } else if (chartType === 'square') {
                options.maintainAspectRatio = false;
                options.plugins.legend.display = false;
                const squareData = datasets[0].data;
                const totalHeight = Math.max(...squareData.map(d => d.y + d.side / 2), 0);
                const totalWidth = Math.max(...squareData.map(d => d.x + d.side / 2), 0);
                options.scales = {
                    x: { display: false, min: 0, max: totalWidth * 1.05 },
                    y: { display: false, min: 0, max: totalHeight * 1.05 }
                };
                options.layout = { padding: 0 };
            } else if (['radar', 'polarArea'].includes(chartType)) {
                 options.scales = { r: { display: true } };
            }
            return options;
        }

        function getColors(count, opacityKey, baseColors, offset = 0) {
            let colors = [];
            for (let i = 0; i < count; i++) {
                const colorObj = baseColors[(i + offset) % baseColors.length];
                const hex = colorObj['1'];
                colors.push(opacityKey === '0.7' ? hexToRgba(hex, 0.7) : hexToRgba(hex, 1.0));
            }
            return colors;
        }

        function handleDragStart(e) { dragSrcRow = this; e.dataTransfer.effectAllowed = 'move'; e.dataTransfer.setData('text/html', this.innerHTML); this.classList.add('dragging'); }
        function handleDragOver(e) { if (e.preventDefault) e.preventDefault(); e.dataTransfer.dropEffect = 'move'; return false; }
        function handleDragEnd(e) { this.classList.remove('dragging'); dragSrcRow = null; this.setAttribute('draggable', 'false'); }
        function handleDrop(e) {
            if (e.stopPropagation) e.stopPropagation();
            if (dragSrcRow !== this) {
                const container = document.getElementById('data-input-container');
                const rows = Array.from(container.children);
                const fromIndex = rows.indexOf(dragSrcRow);
                const toIndex = rows.indexOf(this);
                if (fromIndex < toIndex) this.after(dragSrcRow); else this.before(dragSrcRow);

                document.querySelectorAll('.additional-dataset-block .dataset-body').forEach(body => {
                    const subRows = Array.from(body.children);
                    if (subRows[fromIndex] && subRows[toIndex]) {
                        const subSrc = subRows[fromIndex];
                        const subTarget = subRows[toIndex];
                        if (fromIndex < toIndex) subTarget.after(subSrc); else subTarget.before(subSrc);
                    }
                });
                syncLineDataInputs();
                createOrUpdateChart();
            }
            return false;
        }

        function addInputRow(label = '', value = '', customColor = null) {
            const container = document.getElementById('data-input-container');
            const rowCount = container.children.length;
            const baseColors = getBaseColors();
            const defaultColor = customColor || baseColors[rowCount % baseColors.length]['1'];

            const row = document.createElement('div');
            row.className = 'flex items-center gap-2 data-row group bg-white p-2 rounded-lg border border-transparent hover:border-gray-200 transition-all';
            row.draggable = false; 
            
            const dragHandle = `<div class="drag-handle cursor-grab text-gray-400 hover:text-gray-600 p-1"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16"><path d="M7 2a1 1 0 1 1-2 0 1 1 0 0 1 2 0zm3 0a1 1 0 1 1-2 0 1 1 0 0 1 2 0zM7 5a1 1 0 1 1-2 0 1 1 0 0 1 2 0zm3 0a1 1 0 1 1-2 0 1 1 0 0 1 2 0zM7 8a1 1 0 1 1-2 0 1 1 0 0 1 2 0zm3 0a1 1 0 1 1-2 0 1 1 0 0 1 2 0zm-3 3a1 1 0 1 1-2 0 1 1 0 0 1 2 0zm3 0a1 1 0 1 1-2 0 1 1 0 0 1 2 0zm-3 3a1 1 0 1 1-2 0 1 1 0 0 1 2 0zm3 0a1 1 0 1 1-2 0 1 1 0 0 1 2 0z"/></svg></div>`;
            const colorPickerHtml = `<div class="relative row-color-wrapper"><div class="color-indicator w-6 h-6 rounded-full mr-1 flex-shrink-0 shadow-sm border border-gray-200" style="background-color: ${defaultColor};"></div><input type="color" class="absolute inset-0 opacity-0 cursor-pointer" value="${defaultColor}"></div>`;

            row.innerHTML = `
                ${dragHandle}
                ${colorPickerHtml}
                <input type="text" value="${label}" class="flex-1 min-w-0 px-2 py-2 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500 text-sm" placeholder="í•­ëª©">
                <input type="number" value="${value}" class="w-24 px-2 py-2 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500 text-sm text-right" placeholder="ìˆ˜ì¹˜">
                <button onclick="removeInputRow(this)" class="text-red-400 hover:text-red-600 p-2 rounded-lg transition"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16"><path d="M4.646 4.646a.5.5 0 0 1 .708 0L8 7.293l2.646-2.647a.5.5 0 0 1 .708.708L8.707 8l2.647 2.646a.5.5 0 0 1-.708.708L8 8.707l-2.646 2.647a.5.5 0 0 1-.708-.708L7.293 8 4.646 5.354a.5.5 0 0 1 0-.708z"/></svg></button>
            `;

            const handleDiv = row.querySelector('.drag-handle');
            const colorInput = row.querySelector('input[type="color"]');
            const colorIndicator = row.querySelector('.color-indicator');

            handleDiv.addEventListener('mouseenter', () => row.setAttribute('draggable', 'true'));
            handleDiv.addEventListener('mouseleave', () => { if (!row.classList.contains('dragging')) row.setAttribute('draggable', 'false'); });
            row.addEventListener('dragstart', handleDragStart); row.addEventListener('dragover', handleDragOver); row.addEventListener('drop', handleDrop); row.addEventListener('dragend', handleDragEnd);

            colorInput.addEventListener('input', (e) => {
                colorIndicator.style.backgroundColor = e.target.value;
                createOrUpdateChart();
            });

            container.appendChild(row);
            syncLineDataInputs();
        }

        function removeInputRow(button) { button.closest('.data-row').remove(); syncLineDataInputs(); createOrUpdateChart(); }

        function addDataset() {
            const container = document.getElementById('additional-datasets-container');
            const block = document.createElement('div');
            block.className = 'additional-dataset-block border p-3 rounded-lg relative';
            const datasetCount = container.children.length + 2;
            const baseColors = getBaseColors();
            const defaultColor = baseColors[(datasetCount - 1) % baseColors.length]['1'];
            
            const colorPickerHtml = `
                <div class="dataset-color-container hidden">
                    <label class="block text-sm font-medium text-gray-700 mb-1">ìƒ‰ìƒ</label>
                    <div class="relative h-[38px] w-[40px]">
                        <input type="color" class="dataset-color-picker absolute inset-0 w-full h-full p-0 border-0 rounded cursor-pointer" value="${defaultColor}">
                    </div>
                </div>
            `;

            block.innerHTML = `
                <div class="flex gap-2 items-end mb-4">
                    <div class="flex-1">
                        <label class="block text-sm font-medium text-gray-700 mb-1">ë°ì´í„°ì…‹ ì´ë¦„</label>
                        <input type="text" class="dataset-name w-full px-3 py-2 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500 text-sm" value="ë°ì´í„°ì…‹ ${datasetCount}">
                    </div>
                    ${colorPickerHtml}
                    <button onclick="removeDataset(this)" class="bg-red-500 text-white font-bold h-[38px] w-[40px] rounded-lg hover:bg-red-600 transition flex items-center justify-center">
                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor" viewBox="0 0 16 16"><path d="M4.646 4.646a.5.5 0 0 1 .708 0L8 7.293l2.646-2.647a.5.5 0 0 1 .708.708L8.707 8l2.647 2.646a.5.5 0 0 1-.708.708L8 8.707l-2.646 2.647a.5.5 0 0 1-.708-.708L7.293 8 4.646 5.354a.5.5 0 0 1 0-.708z"/></svg>
                    </button>
                </div>
                <div class="dataset-body space-y-2"></div>
                <div class="dataset-total-display text-right font-bold text-lg text-gray-800 mt-2">í•©ê³„: 0</div>
            `;
            container.appendChild(block);
            
            const colorPicker = block.querySelector('.dataset-color-picker');
            if(colorPicker) colorPicker.addEventListener('input', createOrUpdateChart);

            syncLineDataInputs();
            updateAllTotals();
            
            const chartType = document.getElementById('chartType').value;
            updateUIForChartType(chartType);
        }

        function removeDataset(button) { button.closest('.additional-dataset-block').remove(); createOrUpdateChart(); }

        function syncLineDataInputs() {
            const labels = Array.from(document.querySelectorAll('#data-input-container input[type="text"]')).map(input => input.value.trim());
            document.querySelectorAll('.additional-dataset-block').forEach(block => {
                const body = block.querySelector('.dataset-body');
                const existingValues = Array.from(body.querySelectorAll('input[type="number"]')).map(input => input.value);
                body.innerHTML = ''; 
                labels.forEach((label, index) => {
                    const value = existingValues[index] || '';
                    const row = document.createElement('div');
                    row.className = 'flex items-center gap-2';
                    row.innerHTML = `
                        <span class="synced-label" title="${label}">${label}</span>
                        <input type="number" value="${value}" class="w-2/5 px-2 py-2 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500 dataset-value" placeholder="ìˆ˜ì¹˜">
                        <div class="w-1/5"></div>
                    `;
                    body.appendChild(row);
                });
            });
        }
        
        function saveChartAsImage() {
            if (!myChart || !myChart.canvas) return;
            const sourceCanvas = myChart.canvas;
            const newCanvas = document.createElement('canvas');
            newCanvas.width = sourceCanvas.width; newCanvas.height = sourceCanvas.height;
            const newCtx = newCanvas.getContext('2d');
            newCtx.fillStyle = 'white';
            newCtx.fillRect(0, 0, newCanvas.width, newCanvas.height);
            newCtx.drawImage(sourceCanvas, 0, 0);
            const dataUrl = newCanvas.toDataURL('image/jpeg', 1.0);
            const link = document.createElement('a');
            link.href = dataUrl; link.download = 'graph-chart.jpeg';
            link.click();
        }

        function setupInitialFields() {
            const baseColors = getBaseColors();
            addInputRow('ì°¬ì„±', 30, baseColors[0]['1']);
            addInputRow('ëª¨ë¦„', 20, baseColors[1]['1']);
            addInputRow('ë°˜ëŒ€', 50, baseColors[2]['1']);
        }
        
        window.onload = () => {
            setupInitialFields();
            createOrUpdateChart();

            document.getElementById('chartType').addEventListener('change', (e) => {
                const chartType = e.target.value;
                const isMultiSet = chartType === 'line' || chartType === 'singleStackedBar' || chartType === 'radar'; 
                
                document.getElementById('addDatasetBtn').classList.toggle('hidden', !isMultiSet);
                const container = document.getElementById('additional-datasets-container');
                container.classList.toggle('hidden', !isMultiSet);
                
                if (!isMultiSet) container.innerHTML = '';
                
                updateUIForChartType(chartType);
                createOrUpdateChart();
            });

            document.getElementById('mainDatasetName').addEventListener('input', createOrUpdateChart);
            document.getElementById('mainDatasetColor').addEventListener('input', createOrUpdateChart); 
            document.getElementById('addFieldBtn').addEventListener('click', () => addInputRow());
            document.getElementById('addDatasetBtn').addEventListener('click', addDataset);
            document.getElementById('saveChartBtn').addEventListener('click', saveChartAsImage);
            document.getElementById('data-input-container').addEventListener('input', () => {
                syncLineDataInputs();
                createOrUpdateChart();
                updateAllTotals();
            });
            document.getElementById('additional-datasets-container').addEventListener('input', () => {
                createOrUpdateChart();
                updateAllTotals();
            });
            
            document.getElementById('calc1-total').addEventListener('input', calculate1);
            document.getElementById('calc1-percent').addEventListener('input', calculate1);
            document.getElementById('calc2-total').addEventListener('input', calculate2);
            document.getElementById('calc2-part').addEventListener('input', calculate2);
            document.getElementById('calc3-old').addEventListener('input', calculate3);
            document.getElementById('calc3-new').addEventListener('input', calculate3);
            document.getElementById('calc4-val').addEventListener('input', calculate4);
            document.getElementById('calc4-percent').addEventListener('input', calculate4);
        };
    </script>

</body>
</html>
